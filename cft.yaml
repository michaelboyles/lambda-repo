AWSTemplateFormatVersion: 2010-09-09
Description: Serverless Maven repository
Parameters:
  ServerCodeBucket:
    Description: The name of the S3 bucket containing the server's zipped code bundle
    Type: String
    MinLength: 1
  ServerCodeFilename:
    Description: The filename of the server's zipped code bundle within the given S3 bucket
    Type: String
    Default: lambda-repo.zip
    MinLength: 1
Resources:
  IAMRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${AWS::StackName}-LambdaRepoRole
      Path: /
      Description: Links Lambda Repo lambdas to Lambda Repo policy
      AssumeRolePolicyDocument:
        '{
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service":"lambda.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                }'
      MaxSessionDuration: 3600
      ManagedPolicyArns:
        - !Ref IAMManagedPolicy

  IAMManagedPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub ${AWS::StackName}-LambdaRepoPolicy
      Path: /
      Description: Allows Lambda Repo lambdas to query S3
      PolicyDocument: !Sub |
        {
            "Version": "2012-10-17",
            "Statement": [
                {
                    "Sid": "VisualEditor1",
                    "Effect": "Allow",
                    "Action": [
                        "s3:*",
                        "s3-object-lambda:*"
                    ],
                    "Resource": "${MavenFiles.Arn}*"
                }
            ]
        }

  LambdaGET:
    Type: AWS::Lambda::Function
    Properties:
      Description: Handles GET requests
      FunctionName: !Sub ${AWS::StackName}-GET
      Runtime: nodejs20.x
      MemorySize: 128
      Handler: GET.handler
      Code:
        S3Bucket: !Ref ServerCodeBucket
        S3Key: !Ref ServerCodeFilename
      Role: !GetAtt IAMRole.Arn
      Timeout: 3
      TracingConfig:
        Mode: PassThrough
      Environment:
        Variables:
          BUCKET: !Ref MavenFiles

  LambdaPermissionGET:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt LambdaGET.Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGatewayRestApi}/*/*/*

  LambdaPUT:
    Type: AWS::Lambda::Function
    Properties:
      Description: Handles PUT requests
      FunctionName: !Sub ${AWS::StackName}-PUT
      Runtime: nodejs20.x
      MemorySize: 128
      Handler: PUT.handler
      Code:
        S3Bucket: !Ref ServerCodeBucket
        S3Key: !Ref ServerCodeFilename
      Role: !GetAtt IAMRole.Arn
      Timeout: 3
      TracingConfig:
        Mode: PassThrough
      Environment:
        Variables:
          BUCKET: !Ref MavenFiles

  LambdaPermissionPUT:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt LambdaPUT.Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGatewayRestApi}/*/*/*

  ApiGatewayRestApi:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: !Sub ${AWS::StackName}-lambda-repo-API
      Description: REST API for Lambda Repo
      ApiKeySourceType: HEADER
      EndpointConfiguration:
        Types:
          - REGIONAL

  ApiGatewayResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref ApiGatewayRestApi
      PathPart: "{url+}"
      ParentId: !GetAtt ApiGatewayRestApi.RootResourceId

  ApiGatewayMethodGET:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref ApiGatewayRestApi
      ResourceId: !Ref ApiGatewayResource
      HttpMethod: GET
      AuthorizationType: NONE
      ApiKeyRequired: false
      MethodResponses:
        - ResponseModels:
            "application/json": Empty
          ResponseParameters:
            "method.response.header.Access-Control-Allow-Origin": false
          StatusCode: "200"
      Integration:
        CacheNamespace: !Ref ApiGatewayResource
        ContentHandling: CONVERT_TO_TEXT
        IntegrationHttpMethod: POST
        PassthroughBehavior: WHEN_NO_MATCH
        TimeoutInMillis: 29000
        Type: AWS_PROXY
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${LambdaGET}/invocations

  ApiGatewayMethodPUT:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref ApiGatewayRestApi
      ResourceId: !Ref ApiGatewayResource
      HttpMethod: PUT
      AuthorizationType: NONE
      ApiKeyRequired: false
      MethodResponses:
        - ResponseModels:
            "application/json": Empty
          ResponseParameters:
            "method.response.header.Access-Control-Allow-Origin": false
          StatusCode: "200"
      Integration:
        CacheNamespace: !Ref ApiGatewayResource
        ContentHandling: CONVERT_TO_TEXT
        IntegrationHttpMethod: POST
        PassthroughBehavior: WHEN_NO_MATCH
        TimeoutInMillis: 29000
        Type: AWS_PROXY
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${LambdaPUT}/invocations

  ApiGatewayStage:
    Type: AWS::ApiGateway::Stage
    Properties:
      StageName: default
      DeploymentId: !Ref ApiGatewayDeployment
      RestApiId: !Ref ApiGatewayRestApi
      CacheClusterEnabled: false
      MethodSettings:
        - ResourcePath: "/*"
          HttpMethod: "*"
          CacheDataEncrypted: false
          CachingEnabled: false
          DataTraceEnabled: false
          MetricsEnabled: false
      TracingEnabled: false

  ApiGatewayDeployment:
    Type: AWS::ApiGateway::Deployment
    DependsOn: [
      ApiGatewayMethodGET,
      ApiGatewayMethodPUT
    ]
    Properties:
      RestApiId: !Ref ApiGatewayRestApi

  MavenFiles:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub ${AWS::StackName}-files-${AWS::AccountId}
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
              KMSMasterKeyID: alias/aws/s3
      PublicAccessBlockConfiguration:
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  MavenFilesBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref MavenFiles
      PolicyDocument:
        Id: RequireEncryptionInTransit
        Version: '2012-10-17'
        Statement:
          - Principal: '*'
            Action: '*'
            Effect: Deny
            Resource:
              - !GetAtt MavenFiles.Arn
              - !Sub ${MavenFiles.Arn}/*
            Condition:
              Bool:
                aws:SecureTransport: 'false'
Outputs:
  URL:
    Description: URL to use in POM
    Value: !Sub https://${ApiGatewayRestApi}.execute-api.${AWS::Region}.amazonaws.com/default
